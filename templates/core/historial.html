{% extends 'core/base.html' %}
{% load static %}

{% block content %}
<!-- FLATPICKR CSS (Date Picker) -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<!-- Custom Theme for Flatpickr (Optional, darker) -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/themes/dark.css">

<div class="content-container">
    <div class="head-title">
        <div class="left">
            <h1>Historial de Compras</h1>
        </div>
    </div>

    <!-- SEARCH SECTION (Glassmorphism Cards) -->
    <form method="GET" action="{% url 'historial' %}" class="history-search-form" id="searchForm">
        <div class="search-grid">

            <!-- 1. PRODUCTO -->
            <div class="search-card">
                <div class="card-icon">
                    <i class='bx bx-search-alt'></i>
                </div>
                <div class="card-content">
                    <label>¿Qué buscamos?</label>
                    <input type="text" name="q" placeholder="Ej: Papel Ilustrativo..." value="{{ query }}">
                </div>
            </div>

            <!-- 2. PROVEEDOR -->
            <div class="search-card">
                <div class="card-icon">
                    <i class='bx bxs-store'></i>
                </div>
                <div class="card-content">
                    <label>Proveedor</label>
                    <input type="text" name="provider" placeholder="Ej: Dimagraf..." value="{{ provider }}">
                </div>
            </div>

            <!-- 3. FECHA (DATE RANGE PICKER) -->
            <div class="search-card date-card">
                <div class="card-icon">
                    <i class='bx bx-calendar'></i>
                </div>
                <div class="card-content">
                    <label>Rango de Fechas</label>
                    <input type="text" id="dateRangeInput" name="date_range" placeholder="Seleccionar fechas..."
                        value="{{ date_range }}" readonly>
                </div>
            </div>

            <!-- BUTTON -->
            <button type="submit" class="btn-search-viz">
                <i class='bx bx-filter-alt'></i> Buscar
            </button>
        </div>
    </form>

    <!-- RESULTS TABLE -->
    {% if results %}
    <div class="table-data fade-in-up">
        <div class="order">
            <div class="head">
                <h3>Resultados ({{ results|length }})</h3>
            </div>
            <table>
                <thead>
                    <tr>
                        <th>Fecha</th>
                        <th>Usuario</th>
                        <th>Producto / Insumo</th>
                        <th>Proveedor</th>
                        <th>Detalles</th> <!-- Gramaje/Formato for Paper -->
                        <th>Acción</th>
                    </tr>
                </thead>
                <tbody>
                    {% for orden in ordenes %}
                    <tr>
                        <td>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                {% if orden.usuario.profile.image %}
                                <img src="{{ orden.usuario.profile.image.url }}" alt="User"
                                    style="width: 35px; height: 35px; border-radius: 50%; object-fit: cover;">
                                {% else %}
                                <img src="https://ui-avatars.com/api/?name={{ orden.usuario.username }}&background=random"
                                    style="width: 35px; height: 35px; border-radius: 50%;">
                                {% endif %}
                                <span style="font-weight: 600;">{{ orden.usuario.username|title }}</span>
                            </div>
                        </td>
                        <td>{{ orden.fecha|date:"d/m/Y" }}</td>
                        <td><span class="status completed">Completado</span></td>
                        <td>{{ orden.proveedor }}</td>
                        <td>{{ orden.insumo }}</td>
                        <td>$ {{ orden.total|floatformat:2 }}</td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="6" style="text-align: center; padding: 20px;">No hay compras registradas aún.</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% elif query or provider or date_range %}
    <div class="no-results fade-in-up">
        <i class='bx bx-search-x'></i>
        <p>No se encontraron resultados con estos filtros.</p>
    </div>
    {% else %}
    <!-- EMPTY STATE -->
    <div class="empty-state fade-in-up">
        <i class='bx bx-time-five'></i>
        <h3>Historial de Compras</h3>
        <p>Selecciona un rango de fechas y filtros para consultar órdenes pasadas.</p>
    </div>
    {% endif %}

</div>

<!-- SCRIPTS -->
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/es.js"></script> <!-- Spanish Locale -->

<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Initialize Flatpickr with nice animation
        flatpickr("#dateRangeInput", {
            mode: "range",
            dateFormat: "Y-m-d",
            altInput: true,
            altFormat: "j F, Y",
            locale: "es",
            animate: true,
            disableMobile: "true",
        });

        const form = document.getElementById('searchForm');
        form.addEventListener('submit', function (e) {
            const q = form.querySelector('[name="q"]').value.trim();
            const provider = form.querySelector('[name="provider"]').value.trim();
            const dateParams = form.querySelector('[name="date_range"]').value.trim();

            if (!q && !provider && !dateParams) {
                e.preventDefault();
                alert("Por favor, ingresa al menos un criterio de búsqueda.");
            }
        });
    });
</script>

<style>
    /* LOCAL STYLES */
    .history-search-form {
        margin-bottom: 30px;
    }

    .search-grid {
        display: grid;
        grid-template-columns: 1fr 1fr 1.2fr auto;
        gap: 20px;
        align-items: stretch;
    }

    /* GLASS CARDS */
    .search-card {
        background: var(--light);
        border-radius: 20px;
        padding: 15px 20px;
        display: flex;
        align-items: center;
        gap: 15px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
        transition: transform 0.3s ease, box-shadow 0.3s ease;
        border: 1px solid transparent;
        position: relative;
        overflow: hidden;
    }

    .search-card:focus-within {
        transform: translateY(-3px);
        box-shadow: 0 10px 25px rgba(59, 130, 246, 0.15);
        border-color: var(--blue);
    }

    .search-card::after {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        bottom: 0;
        width: 4px;
        background: var(--grey);
        transition: 0.3s;
    }

    .search-card:focus-within::after {
        background: var(--blue);
    }

    .card-icon {
        width: 45px;
        height: 45px;
        background: var(--light-blue);
        color: var(--blue);
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 24px;
    }

    .card-content {
        flex: 1;
        display: flex;
        flex-direction: column;
    }

    .card-content label {
        font-size: 11px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        color: var(--dark-grey);
        font-weight: 700;
        margin-bottom: 2px;
    }

    .card-content input {
        border: none;
        background: transparent;
        font-size: 15px;
        color: var(--dark);
        outline: none;
        width: 100%;
        font-family: 'Poppins', sans-serif;
    }

    .date-card .card-icon {
        background: var(--light-orange);
        color: var(--orange);
    }

    .date-card:focus-within::after {
        background: var(--orange);
    }

    .btn-search-viz {
        background: var(--blue);
        color: white;
        border: none;
        border-radius: 15px;
        padding: 0 30px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 10px;
        transition: 0.3s;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        height: 100%;
    }

    .btn-search-viz:hover {
        background: var(--dark-blue, #0C4DA2);
        transform: scale(1.02);
    }

    .user-avatar-icon {
        width: 30px;
        height: 30px;
        border-radius: 50%;
        background: linear-gradient(135deg, var(--blue), var(--light-blue));
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 14px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    }

    .no-results,
    .empty-state {
        text-align: center;
        padding: 50px 20px;
        color: var(--dark-grey);
    }

    .no-results i,
    .empty-state i {
        font-size: 60px;
        color: var(--grey);
        margin-bottom: 15px;
        display: block;
    }

    .fade-in-up {
        animation: fadeInUp 0.5s ease-out forwards;
        opacity: 0;
        transform: translateY(20px);
    }

    @keyframes fadeInUp {
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    /* FLATPICKR THEME */
    .flatpickr-calendar {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.5);
        border-radius: 20px;
        box-shadow: 0 15px 40px rgba(0, 0, 0, 0.15);
        font-family: 'Poppins', sans-serif;
    }

    .flatpickr-month {
        background: transparent;
        color: var(--dark);
        fill: var(--dark);
        height: 50px;
    }

    .flatpickr-current-month span.cur-month {
        font-weight: 700;
        color: var(--blue);
    }

    .flatpickr-day.selected,
    .flatpickr-day.startRange,
    .flatpickr-day.endRange,
    .flatpickr-day:hover {
        background: var(--blue);
        border-color: var(--blue);
    }

    .flatpickr-day.inRange {
        background: rgba(59, 130, 246, 0.1);
        border-color: transparent;
        color: var(--blue);
    }

    @media (max-width: 900px) {
        .search-grid {
            grid-template-columns: 1fr 1fr;
        }
    }

    @media (max-width: 600px) {
        .search-grid {
            grid-template-columns: 1fr;
        }

        .btn-search-viz {
            height: 50px;
        }
    }
</style>
{% endblock %}