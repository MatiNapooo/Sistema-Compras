{% extends 'core/base.html' %}
{% load static %}
{% load l10n %}

{% block content %}
<!-- External CSS for Premium Design -->
<link rel="stylesheet" href="{% static 'css/compra_papel.css' %}?v=2.0">
<link rel="stylesheet" href="{% static 'css/cyber-toggle.css' %}?v=1.4">

<div class="content-container">
    <div class="head-title">
        <div class="left">
            <h1>Compra de Papel</h1>
            <ul class="breadcrumb">
                <li><a href="{% url 'nueva_compra' %}">Volver</a></li>
                <li><i class='bx bx-chevron-right'></i></li>
                <li><a class="active" href="#">Papel</a></li>
            </ul>
        </div>
    </div>

    <!-- 1. DETALLES DEL PAPEL -->
    <form class="insumo-form" id="paper-details-form">
        <div class="grid-container" style="grid-template-columns: repeat(4, 1fr);">
            <div class="card-input">
                <label>Papel</label>
                <div class="input-box">
                    <input type="text" id="paper-type" placeholder="Ej: Ilustracion" required>
                </div>
            </div>
            <div class="card-input">
                <label>Formato (cm)</label>
                <div class="input-box" style="gap: 5px;">
                    <input type="number" id="format-w" placeholder="Ancho" required>
                    <span>x</span>
                    <input type="number" id="format-h" placeholder="Alto" required>
                </div>
            </div>
            <div class="card-input">
                <label>Gramaje (gr)</label>
                <div class="input-box">
                    <input type="number" id="grammage" placeholder="Ej: 150" required>
                </div>
            </div>
            <div class="card-input">
                <label>Peso Resma (kg)</label>
                <div class="input-box" style="background: var(--light-orange);">
                    <input type="text" id="ream-weight" placeholder="0.00" readonly style="font-weight: bold;">
                </div>
            </div>
            <div class="card-input full-width">
                <label>Observaciones</label>
                <div class="input-box">
                    <textarea id="observations" placeholder="Detalles adicionales..."></textarea>
                </div>
            </div>
        </div>

        <button type="button" class="btn-confirm" onclick="revealTable()">
            Siguiente
            <i class='bx bx-chevron-down'></i>
        </button>
    </form>

    <!-- 2. TABLA DE PROVEEDORES -->
    <div id="suppliers-section" style="display: none; margin-top: 40px; padding-bottom: 50px;">
        <div class="table-data" style="background: transparent; box-shadow: none; padding: 0;">
            <div class="order">
                <div class="head">
                    <h3>Comparativa de Precios</h3>
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <span style="font-size: 0.9rem; font-weight: 600; color: #666;">USD Venta: <span
                                style="color: var(--blue);">${{ dolar.venta }}</span></span>
                    </div>
                </div>
                <table>
                    <thead>
                        <tr>
                            <th>Proveedor</th>
                            <th>Peso Total</th>
                            <th style="width: 20%;">Precio/Kg</th>
                            <th style="width: 15%; text-align: center;">Moneda</th>
                            <th style="width: 15%; text-align: right;">Precio Resma</th>
                            <th style="width: 10%; text-align: center;">Cant.</th>
                            <th style="width: 15%; text-align: right;">Total</th>
                            <th style="width: 10%; text-align: center;">Acción</th>
                        </tr>
                    </thead>
                    <tbody id="supplier-rows">
                        <!-- Rows injected by JS -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- POPUPS -->
<div id="confirm-popup" class="popup-overlay">
    <div class="popup-content">
        <div class="icon-checkmark" style="background: var(--orange);">
            <i class='bx bx-question-mark'></i>
        </div>
        <h2>Confirmar Compra</h2>
        <p id="popup-message">¿Seguro quieres comprar a ...?</p>
        <div style="display: flex; gap: 10px; justify-content: center;">
            <button class="btn-confirm" style="background: var(--red);" onclick="closePopup()">Cancelar</button>
            <button class="btn-confirm" style="background: var(--green);" onclick="submitPurchase()">Confirmar</button>
        </div>
    </div>
</div>

<div id="success-popup" class="popup-overlay">
    <div class="popup-content" style="position: relative; padding-bottom: 50px;">
        <i class='bx bx-check-circle' style="font-size: 60px; color: var(--blue); margin-bottom: 15px;"></i>
        <h2 style="font-size: 24px; color: var(--dark); margin-bottom: 10px;">¡Orden Creada!</h2>
        <p style="color: #666; font-size: 16px; margin-bottom: 25px;">La orden de compra se registró correctamente.</p>

        <div style="display: flex; justify-content: center;">
            <a id="btn-view-order" href="#" class="btn-confirm"
                style="text-decoration: none; padding: 12px 30px; font-size: 16px; border-radius: 8px;">
                Ver Orden de Compra
            </a>
        </div>

        <button onclick="location.reload()"
            style="position: absolute; bottom: 15px; right: 15px; background: #db504a; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; font-weight: 500; font-size: 14px; display: flex; align-items: center; gap: 5px; box-shadow: 0 2px 5px rgba(0,0,0,0.2);">
            <i class='bx bx-x'></i> Cerrar
        </button>
    </div>
</div>

<script>
    // --- CONFIGURACIÓN INICIAL ---
    const suppliers = ['Dimagraf', 'Cava', 'Resmacon', 'Gravent', 'Castinver', 'Hutton', 'Stenfar', 'Pergamino', 'Tucuman'];

    // 1. OBTENER COTIZACIÓN
    let dolarString = "{{ dolar.venta|default:'0' }}";
    let dolarRate = parseFloat(dolarString.replace(/\./g, '').replace(',', '.')) || 0;

    let rawReamWeight = 0;

    // Formateador para mostrar en pantalla (Argentina: 1.000,00)
    const formatter = new Intl.NumberFormat('es-AR', {
        style: 'decimal',
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
    });

    // Helper inputs 
    function parseVal(id) {
        let v = document.getElementById(id).value;
        return parseFloat(v.replace(',', '.')) || 0;
    }

    // A. CALCULAR PESO RESMA
    function calculateWeight() {
        const w = parseVal('format-w');
        const h = parseVal('format-h');
        const g = parseVal('grammage');

        // Fórmula: (Ancho * Alto * Gramaje) / 20000
        rawReamWeight = (w * h * g) / 20000;

        document.getElementById('ream-weight').value = formatter.format(rawReamWeight);
        updateAllRows();
    }

    ['format-w', 'format-h', 'grammage'].forEach(id => {
        document.getElementById(id).addEventListener('input', calculateWeight);
    });

    // B. GENERAR TABLA (PREMIUM DESIGN + CYBER TOGGLE REMADE)
    function revealTable() {
        calculateWeight();
        if (rawReamWeight <= 0) { alert('Revisar medidas.'); return; }

        const tbody = document.getElementById('supplier-rows');
        tbody.innerHTML = '';

        suppliers.forEach((name, index) => {
            const tr = document.createElement('tr');
            const uniqueId = `cyber-toggle-${index}`;

            tr.innerHTML = `
                <td>
                    <div class="supplier-name">
                        <i class='bx bxs-business'></i>
                        <span>${name}</span>
                    </div>
                </td>
                <td><span class="badge-weight">${formatter.format(rawReamWeight)} kg</span></td>
                
                <td>
                    <div class="input-group-modern">
                        <span class="currency-symbol">$</span>
                        <input type="number" class="price-input" placeholder="0.00" step="0.01">
                    </div>
                </td>
                
                <td class="toggle-cell">
                    <!-- CYBER TOGGLE RESTORED -->
                    <div class="cyber-toggle-wrapper">
                        <input class="cyber-toggle-checkbox dolar-toggle" id="${uniqueId}" type="checkbox" />
                        <label class="cyber-toggle" for="${uniqueId}">
                            <div class="cyber-toggle-track">
                                <div class="cyber-toggle-track-glow"></div>
                                <div class="cyber-toggle-track-dots">
                                    <span class="cyber-toggle-track-dot"></span>
                                    <span class="cyber-toggle-track-dot"></span>
                                    <span class="cyber-toggle-track-dot"></span>
                                </div>
                            </div>
                            <div class="cyber-toggle-thumb">
                                <div class="cyber-toggle-thumb-shadow"></div>
                                <div class="cyber-toggle-thumb-highlight"></div>
                                <div class="cyber-toggle-thumb-icon">
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                                        <path d="M16.5 12c0-2.48-2.02-4.5-4.5-4.5s-4.5 2.02-4.5 4.5 2.02 4.5 4.5 4.5 4.5-2.02 4.5-4.5zm-4.5 7.5c-4.14 0-7.5-3.36-7.5-7.5s3.36-7.5 7.5-7.5 7.5 3.36 7.5 7.5-3.36 7.5-7.5 7.5zm0-16.5c-4.97 0-9 4.03-9 9h-3l3.89 3.89.07.14 4.04-4.03h-3c0-3.87 3.13-7 7-7s7 3.13 7 7-3.13 7-7 7c-1.93 0-3.68-.79-4.94-2.06l-1.42 1.42c1.63 1.63 3.87 2.64 6.36 2.64 4.97 0 9-4.03 9-9s-4.03-9-9-9z"></path>
                                    </svg>
                                </div>
                            </div>
                            <div class="cyber-toggle-particles">
                                <span class="cyber-toggle-particle"></span>
                                <span class="cyber-toggle-particle"></span>
                                <span class="cyber-toggle-particle"></span>
                                <span class="cyber-toggle-particle"></span>
                            </div>
                        </label>
                        <div class="cyber-toggle-labels">
                            <span class="cyber-toggle-label-off">USD</span>
                            <span class="cyber-toggle-label-on">ARS</span>
                        </div>
                    </div>
                </td>

                <td class="text-right"><span class="row-ream-price">$ 0,00</span></td>
                
                <td class="text-center">
                    <div class="qty-control">
                        <input type="number" class="qty-input" value="1" min="1">
                    </div>
                </td>
                
                <td class="text-right"><span class="row-total-final">$ 0,00</span></td>
                
                <td class="text-center">
                    <button class="btn-shop" onclick="confirmPurchase('${name}', this)">
                        <i class='bx bx-cart-alt'></i>
                    </button>
                </td>
            `;
            tbody.appendChild(tr);
        });

        // Activar eventos
        tbody.querySelectorAll('input').forEach(el => {
            el.addEventListener('input', updateRowCalculation);
            el.addEventListener('change', updateRowCalculation);
        });

        document.getElementById('suppliers-section').style.display = 'block';
        setTimeout(() => {
            document.getElementById('suppliers-section').scrollIntoView({ behavior: 'smooth' });
        }, 100);
    }

    // C. CÁLCULO (USER REQUESTED LOGIC KEPT INTACT)
    function updateRowCalculation(e) {
        const row = e.target.closest('tr');
        if (!row) return;

        // A. LEER VALORES
        const priceInputVal = parseFloat(row.querySelector('.price-input').value) || 0;
        const isDolar = row.querySelector('.dolar-toggle').checked;
        const qty = parseInt(row.querySelector('.qty-input').value) || 1;
        const weight = rawReamWeight;

        // B. CALCULAR PRECIO REAL POR KILO (EN PESOS)
        let finalPricePerKg = priceInputVal;

        if (isDolar) {
            // SI ES DOLAR: Multiplicamos el valor ingresado (ej: 100) por la cotización (ej: 1020)
            finalPricePerKg = priceInputVal * dolarRate;
        }

        // C. CALCULAR UNITARIO DE LA RESMA (Peso x Precio/Kg Real)
        let reamUnitPrice = weight * finalPricePerKg;

        // D. CALCULAR TOTAL (Unitario x Cantidad)
        let totalFinal = reamUnitPrice * qty;

        // --- VISUALIZACIÓN ---

        // 1. Símbolo de moneda en el input (solo visual)
        row.querySelector('.currency-symbol').innerText = isDolar ? 'u$d' : '$';

        // 2. Precio Unitario (Siempre mostramos la conversión a pesos para referencia)
        row.querySelector('.row-ream-price').innerText = '$ ' + formatter.format(reamUnitPrice);

        // 3. Total Final (Con puntos de miles)
        const totalSpan = row.querySelector('.row-total-final');
        totalSpan.innerText = '$ ' + formatter.format(totalFinal);

        // Estilo extra para destacar total
        totalSpan.style.color = 'var(--blue)';

        // Styling extra para moneda
        const curSym = row.querySelector('.currency-symbol');
        if (isDolar) {
            curSym.style.color = 'var(--blue)';
            curSym.style.fontWeight = '800';
        } else {
            curSym.style.color = '#adb5bd';
            curSym.style.fontWeight = '700';
        }

        // Guardamos el dato crudo para enviarlo al backend luego
        row.dataset.totalFinal = totalFinal;
    }

    function updateAllRows() {
        document.querySelectorAll('#supplier-rows tr').forEach(tr => {
            const input = tr.querySelector('.price-input');
            if (input) updateRowCalculation({ target: input });
        });
    }

    // 4. CONFIRMAR COMPRA
    function confirmPurchase(supplierName, btn) {
        const row = btn.closest('tr');
        const total = parseFloat(row.dataset.totalFinal) || 0;

        if (total <= 0) {
            alert("El monto debe ser mayor a 0");
            return;
        }

        document.getElementById('popup-message').innerText = `¿Confirmar compra a ${supplierName} por $ ${formatter.format(total)}?`;
        document.getElementById('confirm-popup').classList.add('active');

        // Guardar datos temporales para el envío
        window.tempPurchaseData = {
            proveedor: supplierName,
            total: total,
            detalle: `Papel - ${document.getElementById('paper-type').value} ${document.getElementById('format-w').value}x${document.getElementById('format-h').value}`
        };
    }

    function closePopup() {
        document.getElementById('confirm-popup').classList.remove('active');
    }

    // 5. ENVIAR DATOS
    function submitPurchase() {
        if (!window.tempPurchaseData) return;

        const data = {
            proveedor: window.tempPurchaseData.proveedor,
            precio: window.tempPurchaseData.total,
            insumo: window.tempPurchaseData.detalle,
            observaciones: document.getElementById('observations').value,
            tipo: 'PAPEL',
            marca: '-'
        };

        fetch("{% url 'registrar_compra' %}", {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token }}' },
            body: JSON.stringify(data)
        }).then(r => r.json()).then(d => {
            if (d.status === 'success' && d.id) {
                closePopup();
                document.getElementById('btn-view-order').href = `/orden-compra/${d.id}/`;
                document.getElementById('success-popup').classList.add('active');
            } else {
                alert('Error: ' + d.message);
            }
        });
    }
</script>
{% endblock %}