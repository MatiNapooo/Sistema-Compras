{% extends 'core/base.html' %}
{% load static %}
{% load l10n %}

{% block content %}
<div class="content-container">
    <div class="head-title">
        <div class="left">
            <h1>Compra de Papel</h1>
            <ul class="breadcrumb">
                <li><a href="{% url 'nueva_compra' %}">Volver</a></li>
                <li><i class='bx bx-chevron-right'></i></li>
                <li><a class="active" href="#">Papel</a></li>
            </ul>
        </div>
    </div>

    <!-- 1. DETALLES DEL PAPEL -->
    <form class="insumo-form" id="paper-details-form">
        <div class="grid-container" style="grid-template-columns: repeat(4, 1fr);">
            <div class="card-input">
                <label>Papel</label>
                <div class="input-box">
                    <input type="text" id="paper-type" placeholder="Ej: Ilustracion" required>
                </div>
            </div>
            <div class="card-input">
                <label>Formato (cm)</label>
                <div class="input-box" style="gap: 5px;">
                    <input type="number" id="format-w" placeholder="Ancho" required>
                    <span>x</span>
                    <input type="number" id="format-h" placeholder="Alto" required>
                </div>
            </div>
            <div class="card-input">
                <label>Gramaje (gr)</label>
                <div class="input-box">
                    <input type="number" id="grammage" placeholder="Ej: 150" required>
                </div>
            </div>
            <div class="card-input">
                <label>Peso Resma (kg)</label>
                <div class="input-box" style="background: var(--light-orange);">
                    <input type="text" id="ream-weight" placeholder="0.00" readonly style="font-weight: bold;">
                </div>
            </div>
            <div class="card-input full-width">
                <label>Observaciones</label>
                <div class="input-box">
                    <textarea id="observations" placeholder="Detalles adicionales..."></textarea>
                </div>
            </div>
        </div>

        <button type="button" class="btn-confirm" onclick="revealTable()">
            Siguiente
            <i class='bx bx-chevron-down'></i>
        </button>
    </form>

    <!-- 2. TABLA DE PROVEEDORES (Oculta al principio) -->
    <div id="suppliers-section" style="display: none; margin-top: 40px; padding-bottom: 50px;">
        <div class="table-data">
            <div class="order">
                <div class="head">
                    <h3>Comparativa de Precios</h3>
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <span>USD Venta: ${{ dolar.venta }}</span>
                    </div>
                </div>
                <table>
                    <thead>
                        <tr>
                            <th>Proveedor</th>
                            <th>Peso Total (kg)</th>
                            <th style="width: 15%;">Precio/Kg</th>
                            <th style="width: 8%;">Dólar</th>
                            <th style="width: 15%;">Precio Resma</th>
                            <th style="width: 10%;">Cantidad</th>
                            <th style="width: 15%;">Total</th>
                            <th style="width: 10%;">Acción</th>
                        </tr>
                    </thead>
                    <tbody id="supplier-rows">
                        <!-- Rows injected by JS -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- POPUP -->
<div id="confirm-popup" class="popup-overlay">
    <div class="popup-content">
        <div class="icon-checkmark" style="background: var(--orange);">
            <i class='bx bx-question-mark'></i>
        </div>
        <h2>Confirmar Compra</h2>
        <p id="popup-message">¿Seguro quieres comprar a ...?</p>
        <div style="display: flex; gap: 10px; justify-content: center;">
            <button class="btn-confirm" style="background: var(--red);" onclick="closePopup()">Cancelar</button>
            <button class="btn-confirm" style="background: var(--green);" onclick="submitPurchase()">Confirmar</button>
        </div>
    </div>
</div>

<div id="success-popup" class="popup-overlay">
    <div class="popup-content" style="position: relative; padding-bottom: 50px;">
        <i class='bx bx-check-circle' style="font-size: 60px; color: var(--blue); margin-bottom: 15px;"></i>
        <h2 style="font-size: 24px; color: var(--dark); margin-bottom: 10px;">¡Orden Creada!</h2>
        <p style="color: #666; font-size: 16px; margin-bottom: 25px;">La orden de compra se registró correctamente.</p>

        <!-- Centered View Order Button -->
        <div style="display: flex; justify-content: center;">
            <a id="btn-view-order" href="#" class="btn-confirm"
                style="text-decoration: none; padding: 12px 30px; font-size: 16px; border-radius: 8px;">
                Ver Orden de Compra
            </a>
        </div>

        <!-- Bottom Right Close Button -->
        <button onclick="location.reload()"
            style="position: absolute; bottom: 15px; right: 15px; background: #db504a; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; font-weight: 500; font-size: 14px; display: flex; align-items: center; gap: 5px; box-shadow: 0 2px 5px rgba(0,0,0,0.2);">
            <i class='bx bx-x'></i> Cerrar
        </button>
    </div>
</div>

<script>
    // Lista de proveedores
    const suppliers = ['Dimagraf', 'Cava', 'Resmacon', 'Gravent', 'Castinver', 'Hutton', 'Stenfar', 'Pergamino', 'Tucuman'];

    // Configuración del dólar (segura)
    let dolarRate = 0;
    try {
        let dolarStr = "{{ dolar.venta|default:'0' }}".toString();
        // Backend usually sends 1200 or 1200.50 (number or string with dot)
        // If it sends '1.200,50' (Argentine format), we need to fix it.
        // Step 1: Remove thousands separator (dots) if present AND there is a comma later
        if (dolarStr.includes('.') && dolarStr.includes(',')) {
            dolarStr = dolarStr.replace(/\./g, '');
        } else if (dolarStr.includes(',') && !dolarStr.includes('.')) {
            // Just comma decimal, no thousands
        }

        // Step 2: Replace comma with dot for JS
        dolarStr = dolarStr.replace(',', '.');

        dolarRate = parseFloat(dolarStr);
        if (isNaN(dolarRate)) dolarRate = 0;
        console.log("Cotización Dolar Parsed:", dolarRate);
    } catch (e) {
        console.error("Error al leer dolar:", e);
    }

    let currentSupplier = null;
    let currentTotal = 0;
    let currentQty = 1;
    let rawReamWeight = 0; // Variable global para el peso exacto

    // Función auxiliar para leer números (acepta comas y puntos como separadores)
    // Objetivo: "1.000,50" -> 1000.50 | "1,000.50" -> 1000.50 | "1000" -> 1000
    function parseInputNumber(id) {
        const input = document.getElementById(id);
        if (!input) return 0;
        let val = input.value;
        if (!val) return 0;
        val = val.toString();

        // 1. Si tiene puntos y comas, asumimos formato AR/EU (1.000,50) O US (1,000.50)
        // Heurística simple: el último separador es el decimal.
        const lastDot = val.lastIndexOf('.');
        const lastComma = val.lastIndexOf(',');

        if (lastDot > -1 && lastComma > -1) {
            if (lastComma > lastDot) {
                // Formato: 1.000,50 (AR) -> Quitar puntos, cambiar coma por punto
                val = val.replace(/\./g, '').replace(',', '.');
            } else {
                // Formato: 1,000.50 (US) -> Quitar comas
                val = val.replace(/,/g, '');
            }
        } else if (lastComma > -1) {
            // Solo comas: "10,5" -> 10.5 | "1,000" -> 1000? 
            // Asumimos coma es decimal SIEMPRE en este contexto, salvo que sea conflicto.
            // Para evitar líos: reemplazamos coma por punto.
            val = val.replace(',', '.');
        }
        // Si solo tiene puntos ("1.000"), JS lo toma como 1.
        // Pero si el usuario tipea "1.000" para mil, queremos 1000.
        // SOLUCIÓN: inputs type="number" suelen manejar esto, pero si es type="text"...
        // Aquí asumimos que si hay puntos, son miles si no hay float? No, muy arriesgado.

        // MEJOR APROXIMACION para inputs manuales:
        // Removemos todos los puntos de miles (si parece ser separador de miles)
        // Esto es complejo. Simplifiquemos:
        // Parseamos directo reemplazando comas por puntos.

        // NUEVA ESTRATEGIA ROBUSTA:
        // Eliminar puntos de mil (si hay coma después).
        // "45.000,00" -> Remove . -> "45000,00" -> Replace , -> "45000.00"

        // Limpiar caracteres no numéricos excepto , y .
        val = val.replace(/[^0-9,.-]/g, '');

        if (val.indexOf('.') !== -1 && val.indexOf(',') !== -1) {
            val = val.replace(/\./g, '').replace(',', '.');
        } else if (val.indexOf(',') !== -1) {
            val = val.replace(',', '.');
        }

        return parseFloat(val) || 0;
    }

    // 1. Calcular Peso de la Resma
    function calculateWeight() {
        const w = parseInputNumber('format-w');
        const h = parseInputNumber('format-h');
        const g = parseInputNumber('grammage');

        // Fórmula: (Ancho * Alto * Gramaje) / 20.000 (o 10.000 para gramaje m2?)
        // Asumo fórmula estándar de imprenta: (cm x cm x gr) / 20000 = kg resma
        rawReamWeight = (w * h * g) / 20000;

        // Mostrar en el input de solo lectura
        const displayWeight = rawReamWeight.toLocaleString('es-AR', { minimumFractionDigits: 2, maximumFractionDigits: 3 });
        document.getElementById('ream-weight').value = displayWeight;

        console.log(`Calculando: ${w}x${h}x${g} = ${rawReamWeight}kg`);
        return rawReamWeight;
    }

    // Escuchar cambios en los inputs para recalcular en vivo
    ['format-w', 'format-h', 'grammage'].forEach(id => {
        document.getElementById(id).addEventListener('input', () => {
            calculateWeight();
            // Si la tabla ya está visible, actualizar sus cuentas también
            if (document.getElementById('suppliers-section').style.display !== 'none') {
                updateTableCalculations();
            }
        });
    });

    // 2. Mostrar la Tabla (Función del botón "Siguiente")
    function revealTable() {
        try {
            // Aseguramos que el cálculo esté hecho
            calculateWeight();

            // Validación simple
            if (rawReamWeight <= 0 || isNaN(rawReamWeight)) {
                alert('Por favor completa las medidas y el gramaje correctamente (evita usar 0).');
                return;
            }

            const tbody = document.getElementById('supplier-rows');

            // LIMPIEZA FORZADA: Borramos lo que haya para regenerar limpio
            tbody.innerHTML = '';

            console.log("Generando filas para proveedores...");

            // Generar filas
            suppliers.forEach((name, index) => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td><span style="font-weight: 600;">${name}</span></td>
                    <td><span class="row-weight">0.00</span></td>
                    <td>
                        <div class="input-box" style="width: 120px; padding: 5px 10px;">
                            <span style="margin-right: 5px;">$</span>
                            <input type="number" class="price-input" placeholder="0.00">
                        </div>
                    </td>
                    <td>
                        <div class="cyber-toggle-wrapper">
                            <input class="cyber-toggle-checkbox dolar-toggle" id="cyber-toggle-${index}" type="checkbox" />
                            <label class="cyber-toggle" for="cyber-toggle-${index}">
                                <div class="cyber-toggle-track">
                                    <div class="cyber-toggle-track-glow"></div>
                                    <div class="cyber-toggle-track-dots">
                                        <span class="cyber-toggle-track-dot"></span>
                                        <span class="cyber-toggle-track-dot"></span>
                                        <span class="cyber-toggle-track-dot"></span>
                                    </div>
                                </div>
                                <div class="cyber-toggle-thumb">
                                    <div class="cyber-toggle-thumb-shadow"></div>
                                    <div class="cyber-toggle-thumb-highlight"></div>
                                    <div class="cyber-toggle-thumb-icon">
                                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                                            <path d="M16.5 12c0-2.48-2.02-4.5-4.5-4.5s-4.5 2.02-4.5 4.5 2.02 4.5 4.5 4.5 4.5-2.02 4.5-4.5zm-4.5 7.5c-4.14 0-7.5-3.36-7.5-7.5s3.36-7.5 7.5-7.5 7.5 3.36 7.5 7.5-3.36 7.5-7.5 7.5zm0-16.5c-4.97 0-9 4.03-9 9h-3l3.89 3.89.07.14 4.04-4.03h-3c0-3.87 3.13-7 7-7s7 3.13 7 7-3.13 7-7 7c-1.93 0-3.68-.79-4.94-2.06l-1.42 1.42c1.63 1.63 3.87 2.64 6.36 2.64 4.97 0 9-4.03 9-9s-4.03-9-9-9z"></path>
                                        </svg>
                                    </div>
                                </div>
                                <div class="cyber-toggle-particles">
                                    <span class="cyber-toggle-particle"></span>
                                    <span class="cyber-toggle-particle"></span>
                                    <span class="cyber-toggle-particle"></span>
                                    <span class="cyber-toggle-particle"></span>
                                </div>
                            </label>
                            <div class="cyber-toggle-labels">
                                <span class="cyber-toggle-label-off">USD</span>
                                <span class="cyber-toggle-label-on">ARS</span>
                            </div>
                        </div>
                    </td>
                    <td>
                        <span class="row-ream-price" style="font-weight: bold; color: var(--blue);">0.00</span>
                    </td>
                     <td>
                        <div class="input-box" style="width: 80px; padding: 5px 10px;">
                            <input type="number" class="qty-input" value="1" min="1" step="1">
                        </div>
                    </td>
                    <td>
                        <span class="row-total" style="font-weight: bold; color: var(--blue);">0.00</span>
                    </td>
                    <td>
                        <button class="btn-confirm" style="padding: 8px 15px; font-size: 12px; float: none;" onclick="confirmPurchase('${name}', this)">
                            Comprar
                        </button>
                    </td>
                `;
                tbody.appendChild(tr);
            });

            // Agregar eventos a los nuevos inputs generados
            tbody.querySelectorAll('.price-input, .dolar-toggle, .qty-input').forEach(el => {
                el.addEventListener('input', updateTableCalculations);
                el.addEventListener('change', updateTableCalculations);
            });

            // Mostrar la sección visualmente
            const section = document.getElementById('suppliers-section');
            section.style.display = 'block';

            // Actualizar los números de la tabla recién creada
            updateTableCalculations();

            // Scroll suave hacia la tabla
            setTimeout(() => {
                section.scrollIntoView({ behavior: 'smooth' });
            }, 100);

        } catch (e) {
            alert("Error mostrando tabla: " + e.message);
            console.error(e);
        }
    }

    // 3. Actualizar Cálculos de la Tabla
    function updateTableCalculations() {
        const weight = rawReamWeight;

        document.querySelectorAll('#supplier-rows tr').forEach(row => {
            // Actualizar columna Peso (visual)
            row.querySelector('.row-weight').innerText = weight.toLocaleString('es-AR', { minimumFractionDigits: 2, maximumFractionDigits: 3 });

            const priceInput = row.querySelector('.price-input');
            // 1. Obtener precio por Kg ingresado
            // Usamos la misma lógica: input puede tener puntos de mil y coma decimal.
            // Limpiamos puntos, cambiamos coma por punto.
            let rawPrice = priceInput.value || "0";
            rawPrice = rawPrice.replace(/\./g, '').replace(',', '.');
            let pricePerKgInput = parseFloat(rawPrice) || 0;

            // 2. Determinar precio en PESOS (convertir si es dolar)
            let pricePerKgFinal = pricePerKgInput;

            // Si el toggle está APAGADO (unchecked), el input es en DOLARES -> Convertimos a PESOS
            // Si el toggle está ENCENDIDO (checked), el input es en PESOS -> Directo
            if (!toggle.checked && dolarRate > 0) {
                pricePerKgFinal = pricePerKgInput * dolarRate;
            }

            // 3. Calcular Precio Resma (En PESOS)
            let reamPrice = weight * pricePerKgFinal;

            // 4. Calcular Total Final (Precio Resma * Cantidad)
            let qty = parseInt(qtyInput.value) || 1;
            let total = reamPrice * qty;

            // 5. Renderizar
            // Precio Resma siempre en pesos (o moneda base del sistema)
            reamPriceSpan.innerText = '$ ' + reamPrice.toLocaleString('es-AR', { minimumFractionDigits: 2 });

            // Total Final en pesos
            totalSpan.innerText = '$ ' + total.toLocaleString('es-AR', { minimumFractionDigits: 2 });

            // Debug para el usuario
            // console.log(`Input: ${pricePerKgInput}, Rate: ${dolarRate}, IsUSD: ${toggle.checked} -> FinalKg: ${pricePerKgFinal}`);
        });
    }

    // 4. Confirmar Compra (Popup)
    function confirmPurchase(name, btn) {
        // Buscamos la fila correspondiente al botón clickeado
        const row = btn.closest('tr');
        const price = row.querySelector('.price-input').value;
        const qty = row.querySelector('.qty-input').value;

        if (!price || !qty) {
            alert('Por favor ingresa un precio y una cantidad.');
            return;
        }

        currentSupplier = name;
        currentTotal = row.querySelector('.row-total').innerText; // Guardamos el texto final (ej: "$ 1500.00")
        currentQty = qty;

        document.getElementById('popup-message').innerText = `¿Seguro quieres comprar ${qty} resma(s) a ${name}?`;
        document.getElementById('confirm-popup').classList.add('active');
        document.querySelector('.content-container').classList.add('blur-active');
    }

    function closePopup() {
        document.getElementById('confirm-popup').classList.remove('active');
        document.querySelector('.content-container').classList.remove('blur-active');
    }

    // 5. Enviar al Backend
    function submitPurchase() {
        const paperType = document.getElementById('paper-type').value;
        const w = document.getElementById('format-w').value;
        const h = document.getElementById('format-h').value;
        const g = document.getElementById('grammage').value;
        const obs = document.getElementById('observations').value;

        // Limpiar el total para guardar solo el numero (quitamos $ o USD)
        // Corregido: Eliminar primero los puntos de mil, luego cambiar coma decimal por punto.
        // Ejemplo: "7.400.000,00" -> "7400.000,00" (replace dots) -> "7400000.00" (replace comma)
        let cleanText = currentTotal.replace(/\./g, '').replace(',', '.').replace(/[^0-9.]/g, '');
        let numericPrice = parseFloat(cleanText);

        const data = {
            insumo: `Papel ${paperType} ${w}x${h} ${g}gr (x${currentQty})`,
            proveedor: currentSupplier,
            marca: '-',
            precio: numericPrice,
            observaciones: obs,
            tipo: 'PAPEL'
        };

        fetch("{% url 'registrar_compra' %}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify(data)
        })
            .then(r => r.json())
            .then(d => {
                if (d.status === 'success' && d.id) {
                    closePopup();

                    // Update the "Ver Orden" link with the returned ID
                    const viewOrderBtn = document.getElementById('btn-view-order');
                    // Construct URL manually for the ID
                    viewOrderBtn.href = `/orden-compra/${d.id}/`;

                    document.getElementById('success-popup').classList.add('active');
                } else {
                    alert('Error del servidor: ' + (d.message || 'Unknown'));
                }
            })
            .catch(err => {
                console.error(err);
                alert('Error de conexión al guardar.');
            });
    }
</script>

<link rel="stylesheet" href="{% static 'css/cyber-toggle.css' %}?v=1.2">
{% endblock %}